{% extends "generic_show_form.html.twig" %}
{% import "components/form/fields_macros.html.twig" as fields %}

{% block more_fields %}
    <div class="container bg-white">
        <div class="row g-3 align-items-center p-2">
            <div class="col-3">
                <label for="inputPassword6" class="col-form-label">Selecione o tipo de consulta</label>
               <select class="form-control" id="select-type-zendeskintegration">
                <option>Selecione</option>
                <option value="">Por Usuário</option>
                <option>Por assunto</option>
                <option>Por descrição</option>
               </select>
            </div>
            <div class="col-7">
                <label for="inputPassword6" class="col-form-label">Qual a sua pesquisa</label>
                <input type="text" id="keywork-search-zendeskintegration" class="form-control">
            </div>
            <div class="col-2 d-flex block">
                <div class="row">
                    <div class="col-12">
                    <label for="inputPassword6" class="col-form-label">Consultar</label>
                    </div>
                    <a class="btn btn-success" id="btn-search-ticket-zendesk">
                        <i class="fa fa-search"></i>
                    </a>
                </div>


            </div>
        </div>
        <div class="row g-3 align-items-center p-2">
            <p id="context-zendeskintegration-return">

            </p>
            <ul class="list-group" id='ticket-list'>
                <li class="list-group-item" id="return-description"></li>
            </ul>
        </div>


    </div>

    {# Script inline #}
    {% block javascripts %}

    <script>
        $(document).ready(function() {
            displayAjaxMessageAfterRedirect('message', false)
            $('#btn-search-ticket-zendesk').click(function() {
                var data = {
                    type: $('#select-type-zendeskintegration').val(),
                    name: $('#keywork-search-zendeskintegration').val(),
                    action: 'process_ajax'
                };

                $.ajax({
                    url: '/plugins/zendeskintegration/ajax/search-ticket.php',
                    type: 'POST',
                    data: data,
                    dataType: 'json',
                    success: function(response) {
                        console.log(response.data)

//                         response.data.forEach((element) => {
//                             console.log(element.description)
//                             $("#return-description").remove();
//                             $("#return-description").append(element.description)
//                             $('#ticket-list').append(
//                                 '<li class=\"list-group-item\">' +
//                                 '<strong>Assunto: ' + element.subject + '</strong><br>Descrição: ' +
//                                 element.description.replace(/\\n/g, '<br>') +
//                                 '</li>'
//                             );
// //germanovb@gmail.com
//                         });
                        $("#return-description").append(response.data)
                        // if (response.success) {
                        //     alert('Dados salvos com sucesso: ' + response.message);
                        // } else {
                        //     alert('Erro: ' + response.message);
                        // }
                    },
                    error: function() {
                        alert('Erro na requisição AJAX.');
                    }
                });
            });
        });
        // Função para exibir mensagens no estilo GLPI
        function displayAjaxMessageAfterRedirect(message, isSuccess) {
            console.log('displayAjaxMessageAfterRedirect')
            var alertClass = isSuccess ? 'alert-success' : 'alert-danger';
            var alertIcon = isSuccess ? 'fa-check' : 'fa-exclamation-triangle';
            var alertMessage = '<div class=\"alert ' + alertClass + ' alert-dismissible fade show\" role=\"alert\">' +
                '<i class=\"fa ' + alertIcon + ' me-2\"></i>' +
                message +
                '<button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\" aria-label=\"Close\"></button>' +
                '</div>';

            // Adicionar a mensagem ao topo da página
            if ($('#message_after_redirect').length) {
                $('#message_after_redirect').html(alertMessage);
            } else {
                $('body').prepend('<div id=\"message_after_redirect\" class=\"mt-3\">' + alertMessage + '</div>');
            }

            // Auto-remover após 5 segundos
            setTimeout(function() {
                $('.alert').alert('close');
            }, 5000);
        }
    </script>
    {% endblock %}
{% endblock %}